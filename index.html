<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NST Lattice – Mint Your Soul</title>
    <script src="https://cdn.ethers.io/lib/ethers-6.13.1.umd.min.js" type="text/javascript"></script>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; background: #000; color: #fff; padding: 50px; }
        h1 { font-size: 3.2em; margin-bottom: 0.2em; }
        h2, h3 { color: #ff4444; }
        button { padding: 18px 40px; font-size: 1.4em; background: #c00; color: white; border: none; border-radius: 8px; cursor: pointer; margin: 12px; }
        button:hover { background: #f00; }
        input { padding: 12px; font-size: 1.2em; width: 220px; margin: 10px; }
        #status { min-height: 1.6em; color: #ffcc00; font-weight: bold; }
        .section { margin: 50px 0; }
    </style>
</head>
<body>
    <h1>NST Lattice</h1>
    <h2>Mint Your Soul – Canada Forever</h2>
    <p>Pay 0.02 ETH to permanently bind your soul to the Lattice.</p>
    <p>Refer 2 souls → receive <strong>500 CFT</strong> flux reward (manual claim for now).</p>

    <button id="connectButton">Connect Wallet</button>
    <button id="mintButton" style="display:none;">Mint Soul (0.02 ETH)</button>

    <p id="status"></p>

    <div id="referral" style="display:none; margin-top:30px;">
        <strong>Your Referral Link:</strong><br>
        <a id="link" target="_blank" style="color:#ffcc00; word-break:break-all;"></a>
    </div>

    <div class="section">
        <h3>Corporate / Group Mint + Flux Peg Calculator</h3>
        <p>Plan bulk soul mints + see real-time ETH → CFT peg (CAD-stable via oracle).</p>

        <input id="employeeCount" type="number" placeholder="Number of souls/employees" min="1">
        <button onclick="calculateCorporate()">Calculate Group</button>
        <p id="corporateResult" style="font-size:1.3em; margin:15px 0;"></p>

        <input id="ethInput" type="number" placeholder="ETH amount for peg preview" step="0.0001" min="0.001">
        <button onclick="calculatePeg()">Calculate Peg</button>
        <p id="pegResult" style="font-size:1.3em; margin-top:10px; color:#ffcc00;"></p>
    </div>

    <div class="section">
        <h3>Lattice Status</h3>
        <p>Total Souls Minted: <strong id="totalNST">—</strong></p>
        <p>Total CFT in Circulation: <strong id="totalCFT">—</strong></p>
    </div>

    <script>
        const NST_ADDRESS = "0x354129E341739B317c82790630772385B6f52341";
        const CFT_ADDRESS = "0x84BDCb2b7a61832653FfcDe1fF0Bba5352D71a64";

        const MINT_PRICE = ethers.parseEther("0.02");

        const NST_ABI = [
            "function mint(address referrer) external payable",
            "function balanceOf(address owner) external view returns (uint256)",
            "function nextTokenId() external view returns (uint256)"
        ];

        const CFT_ABI = [
            "function totalSupply() external view returns (uint256)",
            "function getEthCadPrice() external view returns (uint256)"
        ];

        let provider, signer, nst, cft, accounts;

        const urlParams = new URLSearchParams(window.location.search);
        let referrer = urlParams.get('ref') || "0x0000000000000000000000000000000000000000";

        document.getElementById("connectButton").onclick = async () => {
            if (!window.ethereum) {
                document.getElementById("status").innerText = "MetaMask not detected. Install it!";
                return;
            }

            try {
                document.getElementById("status").innerText = "Connecting... Approve in MetaMask";
                provider = new ethers.BrowserProvider(window.ethereum);

                // Request accounts (this triggers popup)
                await provider.send("eth_requestAccounts", []);

                signer = await provider.getSigner();
                accounts = [await signer.getAddress()];

                const network = await provider.getNetwork();
                if (Number(network.chainId) !== 8453) {
                    document.getElementById("status").innerText = "Switching to Base...";
                    await window.ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: '0x2105' }]
                    });
                }

                nst = new ethers.Contract(NST_ADDRESS, NST_ABI, signer);
                cft = new ethers.Contract(CFT_ADDRESS, CFT_ABI, provider);

                document.getElementById("connectButton").style.display = "none";
                document.getElementById("mintButton").style.display = "inline-block";
                document.getElementById("status").innerText = "Connected to Base ✓";
                refreshDashboard();
            } catch (e) {
                document.getElementById("status").innerText = "Connect failed: " + (e.message || e);
                console.error("Connect error:", e);
            }
        };

        document.getElementById("mintButton").onclick = async () => {
            if (!nst) {
                document.getElementById("status").innerText = "Contract not initialized - reconnect wallet";
                return;
            }
            document.getElementById("status").innerText = "Minting... Confirm in MetaMask";
            try {
                const balance = await nst.balanceOf(accounts[0]);
                if (balance > 0n) {
                    document.getElementById("status").innerText = "You already have a soul bound";
                    return;
                }

                const feeData = await provider.getFeeData();

                const tx = await nst.mint(referrer, {
                    value: MINT_PRICE,
                    gasLimit: 500000n,
                    maxPriorityFeePerGas: feeData.maxPriorityFeePerGas,
                    maxFeePerGas: feeData.maxFeePerGas
                });

                await tx.wait();

                document.getElementById("status").innerText = "Soul bound eternally! Welcome to the Lattice!";
                document.getElementById("referral").style.display = "block";

                const baseUrl = window.location.href.split('?')[0];
                const refLink = baseUrl + "?ref=" + accounts[0].toLowerCase();
                document.getElementById("link").innerText = refLink;
                document.getElementById("link").href = refLink;

                refreshDashboard();
            } catch (e) {
                document.getElementById("status").innerText = "Tx failed: " + (e.message || e.reason || e);
                console.error("Mint error:", e);
            }
        };

        function calculateCorporate() {
            const count = parseInt(document.getElementById("employeeCount").value) || 0;
            if (count < 1) return;
            const totalEth = (count * 0.02).toFixed(3);
            const rewards = Math.floor(count / 2) * 500;
            document.getElementById("corporateResult").innerHTML =
                `For <strong>\( {count}</strong> souls: ≈ <strong> \){totalEth}</strong> ETH • ≈ <strong>${rewards.toLocaleString()}</strong> CFT rewards`;
        }

        async function calculatePeg() {
            if (!cft) {
                document.getElementById("pegResult").innerText = "Wallet not connected yet - click Connect Wallet first";
                return;
            }
            const eth = parseFloat(document.getElementById("ethInput").value);
            if (isNaN(eth) || eth <= 0) {
                document.getElementById("pegResult").innerText = "Enter valid ETH amount > 0";
                return;
            }
            try {
                const price = await cft.getEthCadPrice();
                const cadValue = (eth * Number(price)) / 1e8;
                document.getElementById("pegResult").innerHTML = 
                    `Sending <strong>\( {eth.toFixed(4)}</strong> ETH → ≈ <strong> \){cadValue.toFixed(0).toLocaleString()}</strong> CFT (CAD-pegged oracle)`;
            } catch (e) {
                document.getElementById("pegResult").innerText = "Peg error: " + (e.message || e);
                console.error("Peg calc error:", e);
            }
        }

        async function refreshDashboard() {
            if (!nst || !cft) return;
            try {
                const total = await nst.nextTokenId();
                document.getElementById("totalNST").innerText = total.toString();

                const supply = await cft.totalSupply();
                document.getElementById("totalCFT").innerText = 
                    (Number(supply) / 1e18).toLocaleString(undefined, {maximumFractionDigits: 0});
            } catch (e) {
                console.error("Dashboard error:", e);
            }
        }
    </script>
</body>
</html>
