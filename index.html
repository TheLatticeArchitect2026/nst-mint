<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NST Lattice – Mint Your Soul</title>
<script src="https://cdn.jsdelivr.net/npm/web3@1.8.0/dist/web3.min.js"></script>
<style>
body { font-family: Arial, sans-serif; text-align: center; background: #000; color: #fff; padding: 50px; }
h1 { font-size: 3em; }
button { padding: 20px 40px; font-size: 1.5em; background: #c00; color: #fff; border: none; cursor: pointer; margin: 10px; }
button:hover { background: #f00; }
</style>
</head>
<body>
<h1>NST Lattice</h1>
<h2>Mint Your Soul – Canada Forever</h2>
<p id="priceText">Pay 0.02 ETH to mint your permanent, soul-bound NST token.</p>
<p>Invite 2 souls with your referral link – receive 500 CFT flux reward.</p>
<button id="connectButton">Connect Wallet</button>
<button id="mintButton" style="display: none;">Mint Soul</button>
<p id="status"></p>
<p id="referral" style="display: none;">Your referral link:<br><a id="link" target="_blank"></a></p>

<script>
const NST_ADDRESS = "0x6B2951bb85A1b83E90f25E648e8DcD6cA3518D17";
const BASE_CHAIN_ID = 8453;
const BASE_CHAIN_ID_HEX = '0x2105';

const NST_ABI = [
{"inputs":[],"stateMutability":"nonpayable","type":"constructor"},
{"inputs":[],"name":"mint","outputs":[],"stateMutability":"payable","type":"function"},
{"inputs":[],"name":"mintPrice","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
{"inputs":[],"name":"nextTokenId","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
{"inputs":[],"name":"withdraw","outputs":[],"stateMutability":"nonpayable","type":"function"},
{"stateMutability":"payable","type":"receive"}
];

let web3, contract, accounts;

document.getElementById("connectButton").onclick = async () => {
if (window.ethereum) {
try {
web3 = new Web3(window.ethereum);

// Request accounts first
accounts = await ethereum.request({ method: 'eth_requestAccounts' });

// Create contract with correct checksum
contract = new web3.eth.Contract(NST_ABI, NST_ADDRESS);

// Now handle chain switch
let chainId = await web3.eth.getChainId();
if (chainId !== BASE_CHAIN_ID) {
try {
await window.ethereum.request({
method: 'wallet_switchEthereumChain',
params: [{ chainId: BASE_CHAIN_ID_HEX }],
});
} catch (switchError) {
if (switchError.code === 4902 || switchError.code === -32603) {
try {
await window.ethereum.request({
method: 'wallet_addEthereumChain',
params: [{
chainId: BASE_CHAIN_ID_HEX,
chainName: 'Base Mainnet',
nativeCurrency: { name: 'ETH', symbol: 'ETH', decimals: 18 },
rpcUrls: ['https://mainnet.base.org'],
blockExplorerUrls: ['https://basescan.org']
}]
});
await window.ethereum.request({
method: 'wallet_switchEthereumChain',
params: [{ chainId: BASE_CHAIN_ID_HEX }]
});
} catch (addError) {
document.getElementById("status").innerText = "Failed to add Base: " + addError.message;
return;
}
} else {
document.getElementById("status").innerText = "Switch failed: " + switchError.message;
return;
}
}
}

// Final check
chainId = await web3.eth.getChainId();
if (chainId !== BASE_CHAIN_ID) {
document.getElementById("status").innerText = "Still not on Base Mainnet. Switch manually.";
return;
}

// Fetch and display current mint price
try {
const priceWei = await contract.methods.mintPrice().call();
const priceEth = web3.utils.fromWei(priceWei, "ether");
document.getElementById("priceText").innerText = `Pay ${priceEth} ETH to mint your permanent, soul-bound NST token.`;
} catch (priceError) {
document.getElementById("status").innerText = "Failed to fetch mint price: " + priceError.message;
}

document.getElementById("connectButton").style.display = "none";
document.getElementById("mintButton").style.display = "block";
document.getElementById("status").innerText = "Wallet connected on Base Mainnet! Ready to mint.";

} catch (error) {
document.getElementById("status").innerText = "Error: " + error.message;
console.error(error);
}
} else {
document.getElementById("status").innerText = "MetaMask not detected. Install it.";
}
};

document.getElementById("mintButton").onclick = async () => {
if (!contract || !accounts) {
document.getElementById("status").innerText = "Connect wallet first.";
return;
}
document.getElementById("status").innerText = "Minting your soul... (confirm in wallet)";
try {
const priceWei = await contract.methods.mintPrice().call();

const tx = await contract.methods.mint().send({
from: accounts[0],
value: priceWei,
gas: 500000
});

document.getElementById("status").innerText = "Soul minted forever! Tx: " + tx.transactionHash;
document.getElementById("referral").style.display = "block";
const refLink = window.location.href.split('?')[0] + "?ref=" + accounts[0].toLowerCase();
document.getElementById("link").innerText = refLink;
document.getElementById("link").href = refLink;
} catch (error) {
document.getElementById("status").innerText = "Mint failed: " + error.message;
console.error(error);
}
};
</script>
</body>
</html>
